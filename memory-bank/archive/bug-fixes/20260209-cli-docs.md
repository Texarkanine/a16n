# Bug Fix Archive: CLI Docs Showing Same Content For All Versions

## Date
2026-02-09

## Summary
Fixed two bugs causing versioned CLI documentation to show identical content across all versions. The first bug was a wrong pnpm filter name (`@a16njs/cli` instead of `a16n`) causing silent build failures, compounded by missing dist cleanup between version builds. The second bug was stale tracked files persisting across `git checkout` during versioned API doc generation, causing TypeDoc failures for engine@0.1.0–0.4.0.

## Implementation

### Bug 1: CLI docs same content for all versions
- **Root Cause**: `buildCli()` used pnpm filter `@a16njs/cli`, but the CLI package is named `a16n`. Pnpm silently matched no packages and exited 0. Stale dist from HEAD persisted across all version iterations.
- **Fix**: Corrected filter name to `a16n`; added `rmSync` dist cleanup before each build.
- **Regression test**: Reads CLI `package.json` name and asserts it matches the pnpm filter in the script source.

### Bug 2: Versioned doc generation stale files
- **Root Cause**: `git checkout <commit> -- <path>` restores files but doesn't remove tracked files added in later commits. `git clean -fd` only removes untracked files.
- **Fix**: Added `removeStaleFiles()` helper using `git ls-tree` to diff file lists at HEAD vs target commit, then `unlink`s extras.

## Files Changed
- `packages/docs/scripts/generate-cli-docs.ts` — Fixed pnpm filter name, added rmSync dist cleanup
- `packages/docs/test/generate-cli-docs.test.ts` — Added regression test for filter name consistency
- `packages/docs/scripts/generate-versioned-api.ts` — Added removeStaleFiles() helper

## Verification
- All 35 docs tests pass (18 cli-docs + 17 versioned-api)
- Full workspace test suite passes (653 tests across 8 packages)
- Regression test correctly catches the filter name mismatch

## Notes
- Pnpm exits with code 0 when no packages match a filter — a silent failure footgun.
- Node's ESM module cache requires `?t=${Date.now()}` query params for dynamic re-imports, but that alone doesn't help when the underlying dist file hasn't changed — explicit cleanup is also needed.
- `git checkout` + `git clean` is insufficient for reproducing exact historical file states; explicit `git ls-tree` diffing is required.
