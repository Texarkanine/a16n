# CodeRabbit PR Wiggum - Automated PR Feedback Loop

Process CodeRabbit feedback in a loop until resolved or requires human decision.

## Usage

```bash
touch wiggum.semaphore
while [ -e wiggum.semaphore ]; do
  cursor agent /coderabbit-pr-wiggum <pr-url>
  sleep 300
done
```

## Workflow Overview

```mermaid
flowchart TD
    Start([Agent Invoked]) --> Fetch[Fetch CodeRabbit comments]
    Fetch --> UpdateCR[Update Last CodeRabbit Response timestamp]
    
    UpdateCR --> CheckStatus{Status?}
    
    CheckStatus -->|PUSHED_AWAITING_REVIEW| CheckCR{CodeRabbit responded<br/>since Last Push?}
    CheckCR -->|No| ExitWait([Exit - keep waiting])
    CheckCR -->|Yes| EvalNew{New actionable<br/>items?}
    EvalNew -->|No| Complete[Mark COMPLETE<br/>Delete semaphore]
    EvalNew -->|Yes| SetInProgress[Status → IN_PROGRESS]
    SetInProgress --> Process
    
    CheckStatus -->|IN_PROGRESS| HasNew{New actionable<br/>items?}
    HasNew -->|No| ExitIdle([Exit - nothing to do])
    HasNew -->|Yes| Process
    
    Process[Process actionable items] --> Fix[Fix each item<br/>using /niko/build]
    Fix --> Test{Tests pass?}
    Test -->|No| Revert[Revert, mark REQUIRES_HUMAN]
    Revert --> ExitFail([Exit])
    
    Test -->|Yes| Reflect["/niko/reflect"]
    Reflect --> Commit["Commit & Push"]
    Commit --> SetPushed[Status → PUSHED_AWAITING_REVIEW<br/>Update Last Push timestamp]
    SetPushed --> ExitPushed([Exit - await CR response])
    
    Complete --> ExitDone([Exit - done])
```

## Semaphore Contract

| Status | Semaphore | Next Action |
|--------|-----------|-------------|
| `IN_PROGRESS` | Keep | Process items or wait for new ones |
| `PUSHED_AWAITING_REVIEW` | Keep | Wait for CodeRabbit to respond |
| `COMPLETE` | Delete | Loop terminates |
| `NEEDS_HUMAN` | Delete | Loop terminates |

**Key rule**: Only delete semaphore after CodeRabbit has responded to your push with no actionable feedback.

## Tracking File

Location: `memory-bank/wiggum/pr-<number>.md`

```markdown
# Wiggum: PR #<number>

## Metadata
| Field | Value |
|-------|-------|
| PR URL | <url> |
| Last Check | <ISO timestamp> |
| Last Push | <ISO timestamp or "never"> |
| Last CodeRabbit Response | <ISO timestamp> |
| Status | IN_PROGRESS / PUSHED_AWAITING_REVIEW / COMPLETE / NEEDS_HUMAN |

## Feedback Tracking

### Actionable
- [ ] ID: <id> - <summary> - PENDING
- [x] ID: <id> - <summary> - FIXED

### Requires Human Decision
- ID: <id> - <summary> - Reason: <why>

### Ignored
- ID: <id> - <summary> - Reason: <why>

## Fix History
### Fix 1 - <timestamp>
- Comments: <ids>
- Resolution: <summary>
- Files: <list>
```

## Phase Details

### Phase 1: Fetch & Track

1. Extract PR number from URL
2. Load or create tracking file (`mkdir -p memory-bank/wiggum`)
3. Fetch CodeRabbit comments:
   ```bash
   gh api repos/{owner}/{repo}/pulls/{number}/comments --paginate
   gh api repos/{owner}/{repo}/pulls/{number}/reviews --paginate
   ```
4. Filter for `coderabbitai[bot]` user
5. Update `Last CodeRabbit Response` to most recent comment timestamp

### Phase 2: Categorize

**ACTIONABLE** - Auto-fixable:
- Code style, missing error handling, type issues
- Documentation gaps, import/export issues

**REQUIRES_HUMAN** - Needs decision:
- Architectural changes, API design, breaking changes
- Security-sensitive, public interface changes

**IGNORED** - Not applicable:
- False positives, already addressed, conflicts with project standards

### Phase 3: Decide

**If `PUSHED_AWAITING_REVIEW`:**
- Compare `Last CodeRabbit Response` vs `Last Push`
- If CR hasn't responded yet → Exit (keep waiting)
- If CR responded → Check for new actionable items
  - None → `COMPLETE`, delete semaphore
  - Found → `IN_PROGRESS`, continue to Phase 4

**If `IN_PROGRESS`:**
- No new actionable items → Exit (idle)
- New actionable items → Continue to Phase 4
- Only REQUIRES_HUMAN remain → `NEEDS_HUMAN`, delete semaphore

### Phase 4: Fix → Reflect → Push

For each actionable item:

1. **Fix** using `/niko/build` workflow (Level 1 complexity)
2. Mark as FIXED in tracking file
3. Record in Fix History

After all fixes:

4. **Test**: `pnpm test && pnpm build`
   - If fail: Revert, mark as REQUIRES_HUMAN, exit
5. **Reflect**: Run `/niko/reflect` to document changes
6. **Commit & Push**:
   ```bash
   git add -A
   git commit --no-gpg-sign -m "fix: address CodeRabbit feedback

   <summary of fixes>

   Generated by wiggum automation"
   git push
   ```
7. Update tracking:
   - `Last Push` → current timestamp
   - `Status` → `PUSHED_AWAITING_REVIEW`
8. **Exit** (semaphore stays, await CR response)

## Notes

- Each fix is Level 1 complexity (small, focused)
- 5-minute sleep allows CodeRabbit time to re-analyze
- Use `--no-gpg-sign` and `--no-pager` for git commands
- "No new comments" ≠ approval (CR might still be processing)
