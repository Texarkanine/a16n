# TASK ARCHIVE: Documentation System - Comprehensive Implementation

## METADATA

| Field | Value |
|-------|-------|
| Task IDs | DOCS-SITE-MVP, DOCS-PIVOT-STAGING, TEST-FIXES-20260129 |
| Dates | 2026-01-28 to 2026-01-29 |
| Complexity | Level 3 → Level 4 (evolved during implementation) |
| Branch | `docs` |
| PR | #18 |
| Status | ✅ Complete |

---

## SUMMARY

Implemented a comprehensive versioned API documentation system for the a16n monorepo using Docusaurus. The project evolved from a simple MVP to a full-featured documentation platform with:

- **Staging area pattern**: Prose in `docs/` (committed), API docs generated to `.generated/` (gitignored)
- **Git tag-based versioned APIs**: Historical API docs for all tagged releases
- **React version picker**: Dynamic dropdown for navigating between API versions
- **Parallel TypeDoc generation**: 6x speedup (66s → 11s)
- **Dual build modes**: Local dev (`current`) vs CI (tagged versions only)
- **Custom sidebar sorting**: Semantic versioning (newest first)
- **Search integration**: Local search with version exclusion
- **Build optimizations**: Webpack caching, @docusaurus/faster, disabled source maps

### Key Metrics

| Metric | Before | After |
|--------|--------|-------|
| Committed API files | 46 | 0 |
| TypeDoc time (current) | ~66s sequential | ~11s parallel |
| Webpack build (first) | ~192s | ~150s (SWC/Lightning CSS) |
| Webpack build (cached) | N/A | ~80s (50% faster) |
| API versions documented | 1 (current) | All git tags |
| Location | `apps/docs/` | `packages/docs/` |

---

## REQUIREMENTS

### Original Goals (DOCS-SITE-MVP)

1. ✅ Private workspace package with Docusaurus dependencies
2. ✅ Placeholder hand-written docs for all packages
3. ✅ GitHub Actions workflow for deployment
4. ✅ Package READMEs stay in-package

### Extended Goals (DOCS-PIVOT-STAGING)

1. ✅ Remove committed API docs (46 files)
2. ✅ Staging area build flow (`.generated/`)
3. ✅ TypeDoc integration (standalone, not plugin)
4. ✅ Version picker component (React dropdown)
5. ✅ Versioned API generation from git tags
6. ✅ CI workflow with full git history
7. ✅ Local search with version exclusion

---

## IMPLEMENTATION

### Phase 1: Documentation Site MVP (2026-01-28)

**Duration:** ~2 hours

Created initial Docusaurus site at `apps/docs/` with:
- Basic configuration without TypeDoc plugins (version conflicts)
- 6 placeholder guides + intro page
- Turbo integration
- GitHub Actions workflow

**Key Decision:** Deferred TypeDoc plugin integration due to `typedoc@0.27` vs `typedoc-plugin-markdown@4.9.0` incompatibility.

### Phase 2: Staging Area Refactor

Moved from committed API docs to staging area pattern:

```
packages/docs/
  docs/             # COMMITTED: hand-written prose
  .generated/       # GITIGNORED: staging area
    intro.md        # copied from docs/
    */api/          # generated by TypeDoc
  build/            # GITIGNORED: final static site
```

**Scripts Implemented:**
- `stage`: Copy prose to `.generated/`
- `apidoc:*`: Parallel TypeDoc generation (6 packages)
- `build`: stage → apidoc → docusaurus build

### Phase 3: Versioned API Generation

Created TypeScript script `generate-versioned-api.ts`:

1. **Tag iteration**: Parse git tags by package (`@a16njs/models@0.2.0`)
2. **Monorepo resolution**: Check out ALL packages from same commit for type compatibility
3. **TypeDoc generation**: Use `typedoc.versioned.json` with path mappings
4. **Post-processing**: Rename README.md → index.md with frontmatter
5. **Manifest creation**: Write `versions.json` for VersionPicker

**Key Challenge:** Historical builds failed with type errors until we started checking out all workspace packages from the same commit.

### Phase 4: Version Picker Component

Created React component `VersionPicker/index.tsx`:
- Reads `versions.json` manifest
- BrowserOnly wrapper for SSR compatibility
- URL pattern matching with trailing slash handling
- Navigates between wrapper pages and versioned docs

### Phase 5: Dual Build Modes

| Mode | When | Behavior |
|------|------|----------|
| `start:full` | Local dev | Generates "current" API from working directory |
| `build` | CI | Generates ONLY from git tags (deterministic) |

This ensures CI never creates bogus "latest" versions.

### Phase 6: Post-Deployment Troubleshooting

#### Issue 1: Sidebar Version Sorting

**Problem:** Versions showed oldest-first (0.2.0, 0.3.0) instead of newest-first

**Root Cause:** Custom `sidebarItemsGenerator` only sorted children, not top-level items. The recursive function handled child arrays but never sorted the items array itself.

**Solution:** Sort items at every level, not just children:
```javascript
function sortVersions(items) {
  items.forEach(item => {
    if (item.items) sortVersions(item.items);
  });
  items.sort((a, b) => { /* version comparison */ });  // THIS WAS MISSING
}
```

#### Issue 2: VersionPicker "current" in Production

**Problem:** Hardcoded "current (latest)" option always showed, even when no current API existed

**Solution:** Removed hardcoded option, made first version (latest) the default selection

#### Issue 3: Webpack Config Location

**Problem:** `"webpack" must be of type object` error

**Root Cause:** Webpack config was at top-level, but Docusaurus requires it via plugin's `configureWebpack` lifecycle method

**Solution:** Created inline plugin in `plugins` array

#### Issue 4: Broken Curated Links

**Problem:** Wrapper pages had links to unversioned API paths that don't exist

**Solution:** Removed all curated links, simplified wrapper pages to description + VersionPicker + sidebar navigation

### Phase 7: Test Fixes and Build Optimization

#### ManualPrompt Rebase Error

**Problem:** Rebase incorrectly renamed `ManualPrompt` to `AgentCommand` across multiple packages

**Solution:** Restored files from `main` branch using `git checkout main -- <files>`

**Complication:** Turbo's aggressive caching required clearing `~/.turbo/cache`, all `dist/` folders, and stopping the daemon

#### Missing tsx Dependency

**Problem:** glob-hook CLI tests used `npx tsx` but it wasn't in devDependencies

**Solution:** Added `tsx` to glob-hook's devDependencies

#### docs#test Optimization

**Problem:** `pnpm test` triggered docs build unnecessarily

**Solution:** Added turbo.json task override:
```json
"docs#test": { "dependsOn": [] }
```

#### Dead Code Removal

**Problem:** CodeRabbit flagged unused `createLatestSymlink` function; agent incorrectly added a call to it

**Solution:** Removed the function entirely (we don't want "latest" symlinks)

---

## TESTING

### Build Verification

```bash
pnpm --filter docs run build  # Exit 0, ~240s
pnpm run test                 # 365 tests pass across 7 packages
```

### Verification Points

- ✅ `.generated/` structure correct
- ✅ API docs render properly
- ✅ Version picker navigates correctly
- ✅ Search indexes only latest versions
- ✅ No generated files in git
- ✅ Sidebar shows newest-first
- ✅ Homepage at `/` (not 404)
- ✅ All tests pass

---

## LESSONS LEARNED

### Technical Lessons

1. **Monorepo TypeDoc needs version alignment**: When generating historical docs, ALL packages must be checked out from the same commit for type resolution

2. **Docusaurus routing is file-based + frontmatter**: Multiple files can't claim the same URL; use unique `slug` frontmatter

3. **Turbo cache fingerprints source files**: After git operations, may need `--force` or cache clearing

4. **Package-specific turbo tasks**: The `package#task` syntax allows per-package dependency overrides

5. **Recursive functions need ALL levels**: The sidebar sorting bug was caused by only sorting children, not the top-level array

6. **Webpack customization via plugins**: Docusaurus doesn't support top-level webpack config; use `configureWebpack` lifecycle method

7. **CLI tools ≠ Library APIs**: Not every package needs API docs; CLI tools are documented via `--help` and usage guides

### Process Lessons

1. **Batch changes when builds are slow**: With 5-minute builds, analyze and fix multiple issues before triggering a build

2. **Debug logging reveals hidden assumptions**: Adding logging at every level found the sidebar sorting bug

3. **Spec location matters**: Always verify specs against existing project structure (`apps/` vs `packages/`)

4. **User feedback loops are valuable**: Quick, specific feedback enabled rapid iteration

5. **Rebase errors compound**: One incorrect resolution cascaded into failures across multiple packages

---

## TROUBLESHOOTING SESSIONS

### Sidebar Sorting (troubleshooting-20260129-sidebar-sorting-final.md)

- **Symptom**: Versions oldest-first (0.2.0, 0.3.0)
- **Hypothesis**: Sidebar generator not running, logic error, scope issue
- **Root Cause**: Sort function only sorted children, not top-level items
- **Fix**: Sort items array at every level
- **Verification**: Newest-first after fix

### Version Sorting & Display (troubleshooting-20260129-version-sorting.md)

- **Issues**: Wrong sidebar order, "current (latest)" in prod
- **Root Causes**: 
  1. Sorting looked for " (latest)" in labels that didn't have it
  2. Hardcoded option always showed
- **Fixes**: 
  1. Detect latest, append label, then sort
  2. Remove hardcoded option, use first version as default

### Webpack Config (troubleshooting-20260129-webpack-config.md)

- **Error**: `"webpack" must be of type object`
- **Root Cause**: Wrong location (top-level vs plugin lifecycle)
- **Documentation**: https://docusaurus.io/docs/api/plugin-methods/lifecycle-apis#configureWebpack
- **Fix**: Created inline plugin with `configureWebpack` method

---

## FILES CHANGED

### New Files

| File | Purpose |
|------|---------|
| `packages/docs/src/components/VersionPicker/index.tsx` | React version selector |
| `packages/docs/src/components/VersionPicker/styles.module.css` | Component styles |
| `packages/docs/scripts/generate-versioned-api.ts` | Git tag-based API generation |
| `packages/docs/typedoc.json` | TypeDoc config for current API |
| `packages/docs/typedoc.versioned.json` | TypeDoc config with path mappings |
| `packages/docs/docs/*/api.mdx` | Curated API wrapper pages (4 packages) |
| `packages/docs/README.md` | Documentation for build modes |
| `.github/workflows/docs.yaml` | GitHub Actions deployment |

### Modified Files

| File | Change |
|------|--------|
| `packages/docs/package.json` | Staging scripts, parallel TypeDoc, @docusaurus/faster |
| `packages/docs/docusaurus.config.js` | `.generated/` path, custom sidebarItemsGenerator, webpack plugin |
| `packages/docs/sidebars.js` | Category + autogenerated items |
| `packages/docs/docs/intro.md` | `slug: /`, updated links |
| `packages/glob-hook/src/*.ts` | ESM import extensions |
| `packages/glob-hook/package.json` | Added tsx devDependency |
| `turbo.json` | Added `docs#test` override |
| `.gitignore` | Correct paths for packages/docs/ |
| `pnpm-workspace.yaml` | Removed apps/* |
| `planning/DOCS_2.md` | Corrected location references |

### Deleted Files

| File | Reason |
|------|--------|
| `apps/docs/api/**` | 46 committed TypeDoc files removed |
| `apps/` directory | No longer needed |
| `packages/docs/docs/cli/api.mdx` | CLI tool, not library |
| `packages/docs/docs/glob-hook/api.mdx` | CLI tool, not library |

---

## COMMITS

| Hash | Description |
|------|-------------|
| `7057f71` | refactor(docs): remove committed API docs |
| `2d3c00d` | feat(docs): implement staging area build scripts |
| `4264b4d` | fix(glob-hook): add .js extensions to imports |
| `a48de31` | refactor(docs): move to packages/docs |
| `df4f05f` | fix(docs): remove unused createLatestSymlink function |
| Various | feat(docs): versioned API, version picker, sidebar sorting, webpack optimization |

---

## ARCHITECTURAL DECISIONS

| Decision | Rationale |
|----------|-----------|
| Staging area at `.generated/` | Matches spec; keeps generated content out of repo |
| Standalone TypeDoc | Simpler than `docusaurus-plugin-typedoc`; direct control |
| TypeScript over shell script | Type safety, testability, cross-platform |
| Git tag-based versions | Tags exist; enables historical API docs |
| Dual build modes | CI determinism (tags only) vs local flexibility |
| Wrapper pages simplified | Provide context without maintenance burden |
| CLI tools excluded | They're not libraries, no public API surface |
| No " (latest)" labels | User preference for cleaner UI |
| Webpack via plugin | Docusaurus API requires lifecycle methods |

---

## FUTURE ENHANCEMENTS

- **Incremental builds**: Cache versioned API generation by tag
- **Version comparison**: Diff view between API versions
- **API search scoping**: Filter search by specific version
- **Automated screenshots**: Visual regression testing
- **Hot module replacement**: Faster dev server reloads

---

## REFERENCES

- Reflection: `memory-bank/reflection/reflection-DOCS-SITE-MVP.md` (archived)
- Reflection: `memory-bank/reflection/reflection-DOCS-PIVOT-STAGING.md` (archived)
- Reflection: `memory-bank/reflection/reflection-20260129-TEST-FIXES.md` (archived)
- Troubleshooting: `memory-bank/troubleshooting/troubleshooting-20260129-sidebar-sorting-final.md` (archived)
- Troubleshooting: `memory-bank/troubleshooting/troubleshooting-20260129-version-sorting.md` (archived)
- Troubleshooting: `memory-bank/troubleshooting/troubleshooting-20260129-webpack-config.md` (archived)
- Spec: `planning/DOCS.md`, `planning/DOCS_2.md`
