# Project Setup Guide

**Exact commands to bootstrap the a16n monorepo.**

## Prerequisites

```bash
# Ensure Node.js 18+ is installed
node --version  # Should be v18.x or higher

# Install pnpm globally
npm install -g pnpm

# Verify pnpm
pnpm --version  # Should be 8.x or higher
```

## Step 1: Initialize Repository

```bash
# Create and enter project directory
mkdir a16n && cd a16n

# Initialize git
git init

# Create root package.json
cat > package.json << 'EOF'
{
  "name": "a16n-monorepo",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "typecheck": "turbo run typecheck",
    "clean": "turbo run clean && rm -rf node_modules",
    "changeset": "changeset",
    "version-packages": "changeset version",
    "release": "pnpm build && changeset publish"
  },
  "devDependencies": {
    "@changesets/cli": "^2.27.0",
    "turbo": "^2.0.0",
    "typescript": "^5.4.0"
  },
  "packageManager": "pnpm@9.0.0",
  "engines": {
    "node": ">=18.0.0"
  }
}
EOF
```

## Step 2: Configure pnpm Workspaces

```bash
# Create pnpm workspace config
cat > pnpm-workspace.yaml << 'EOF'
packages:
  - "packages/*"
EOF
```

## Step 3: Configure Turborepo

```bash
# Create turbo.json
cat > turbo.json << 'EOF'
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    },
    "test": {
      "dependsOn": ["build"]
    },
    "lint": {},
    "typecheck": {
      "dependsOn": ["^build"]
    },
    "clean": {
      "cache": false
    }
  }
}
EOF
```

## Step 4: Configure TypeScript

```bash
# Create base TypeScript config
cat > tsconfig.base.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022"],
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noUncheckedIndexedAccess": true,
    "noEmit": false
  }
}
EOF
```

## Step 5: Configure Changesets

```bash
# Initialize changesets
mkdir -p .changeset

cat > .changeset/config.json << 'EOF'
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
EOF

cat > .changeset/README.md << 'EOF'
# Changesets

Hello and welcome! This folder has been automatically generated by `@changesets/cli`.

To add a new changeset, run `pnpm changeset` in the root of the repository.
EOF
```

## Step 6: Create .gitignore

```bash
cat > .gitignore << 'EOF'
# Dependencies
node_modules/

# Build outputs
dist/
*.tsbuildinfo

# Turbo
.turbo/

# IDE
.idea/
.vscode/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log
npm-debug.log*

# Test coverage
coverage/

# Environment
.env
.env.local
EOF
```

## Step 7: Create Package Directories

```bash
# Create all package directories
mkdir -p packages/models/src
mkdir -p packages/engine/src
mkdir -p packages/cli/src
mkdir -p packages/plugin-cursor/src
mkdir -p packages/plugin-claude/src
```

## Step 8: Initialize @a16njs/models

```bash
cat > packages/models/package.json << 'EOF'
{
  "name": "@a16njs/models",
  "version": "0.0.1",
  "description": "Type definitions and plugin interface for a16n",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist *.tsbuildinfo",
    "typecheck": "tsc --noEmit",
    "test": "echo 'No tests yet'"
  },
  "devDependencies": {
    "typescript": "^5.4.0"
  }
}
EOF

cat > packages/models/tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
EOF

cat > packages/models/src/index.ts << 'EOF'
// Types
export enum CustomizationType {
  GlobalPrompt = 'global-prompt',
  AgentSkill = 'agent-skill',
  FileRule = 'file-rule',
  AgentIgnore = 'agent-ignore',
}

export interface AgentCustomization {
  id: string;
  type: CustomizationType;
  sourcePath: string;
  content: string;
  metadata: Record<string, unknown>;
}

export interface GlobalPrompt extends AgentCustomization {
  type: CustomizationType.GlobalPrompt;
}

// Plugin interface
export interface A16nPlugin {
  id: string;
  name: string;
  supports: CustomizationType[];
  discover(root: string): Promise<DiscoveryResult>;
  emit(models: AgentCustomization[], root: string): Promise<EmitResult>;
}

export interface DiscoveryResult {
  items: AgentCustomization[];
  warnings: Warning[];
}

export interface EmitResult {
  written: WrittenFile[];
  warnings: Warning[];
  unsupported: AgentCustomization[];
}

export interface WrittenFile {
  path: string;
  type: CustomizationType;
  itemCount: number;
}

// Warnings
export enum WarningCode {
  Merged = 'merged',
  Approximated = 'approximated',
  Skipped = 'skipped',
  Overwritten = 'overwritten',
}

export interface Warning {
  code: WarningCode;
  message: string;
  sources?: string[];
  details?: Record<string, unknown>;
}

// Helpers
export function isGlobalPrompt(item: AgentCustomization): item is GlobalPrompt {
  return item.type === CustomizationType.GlobalPrompt;
}

export function createId(type: CustomizationType, sourcePath: string): string {
  return `${type}:${sourcePath}`;
}
EOF
```

## Step 9: Initialize @a16njs/engine

```bash
cat > packages/engine/package.json << 'EOF'
{
  "name": "@a16njs/engine",
  "version": "0.0.1",
  "description": "Conversion engine for a16n",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist *.tsbuildinfo",
    "typecheck": "tsc --noEmit",
    "test": "echo 'No tests yet'"
  },
  "dependencies": {
    "@a16njs/models": "workspace:*"
  },
  "devDependencies": {
    "typescript": "^5.4.0"
  }
}
EOF

cat > packages/engine/tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
EOF

cat > packages/engine/src/index.ts << 'EOF'
import type {
  A16nPlugin,
  AgentCustomization,
  DiscoveryResult,
  Warning,
  WrittenFile,
  CustomizationType,
} from '@a16njs/models';

export interface ConversionOptions {
  source: string;
  target: string;
  root: string;
  dryRun?: boolean;
}

export interface ConversionResult {
  discovered: AgentCustomization[];
  written: WrittenFile[];
  warnings: Warning[];
  unsupported: AgentCustomization[];
}

export interface PluginInfo {
  id: string;
  name: string;
  supports: CustomizationType[];
  source: 'bundled' | 'installed';
}

export class A16nEngine {
  private plugins: Map<string, A16nPlugin> = new Map();

  constructor(plugins: A16nPlugin[] = []) {
    for (const plugin of plugins) {
      this.registerPlugin(plugin);
    }
  }

  registerPlugin(plugin: A16nPlugin): void {
    this.plugins.set(plugin.id, plugin);
  }

  listPlugins(): PluginInfo[] {
    return Array.from(this.plugins.values()).map((p) => ({
      id: p.id,
      name: p.name,
      supports: p.supports,
      source: 'bundled' as const,
    }));
  }

  getPlugin(id: string): A16nPlugin | undefined {
    return this.plugins.get(id);
  }

  async discover(pluginId: string, root: string): Promise<DiscoveryResult> {
    const plugin = this.getPlugin(pluginId);
    if (!plugin) {
      throw new Error(`Unknown plugin: ${pluginId}`);
    }
    return plugin.discover(root);
  }

  async convert(options: ConversionOptions): Promise<ConversionResult> {
    const sourcePlugin = this.getPlugin(options.source);
    const targetPlugin = this.getPlugin(options.target);

    if (!sourcePlugin) {
      throw new Error(`Unknown source: ${options.source}`);
    }
    if (!targetPlugin) {
      throw new Error(`Unknown target: ${options.target}`);
    }

    // Discover from source
    const discovery = await sourcePlugin.discover(options.root);

    if (options.dryRun) {
      return {
        discovered: discovery.items,
        written: [],
        warnings: discovery.warnings,
        unsupported: [],
      };
    }

    // Emit to target
    const emission = await targetPlugin.emit(discovery.items, options.root);

    return {
      discovered: discovery.items,
      written: emission.written,
      warnings: [...discovery.warnings, ...emission.warnings],
      unsupported: emission.unsupported,
    };
  }
}
EOF
```

## Step 10: Initialize Plugin Stubs

```bash
# @a16njs/plugin-cursor
cat > packages/plugin-cursor/package.json << 'EOF'
{
  "name": "@a16njs/plugin-cursor",
  "version": "0.0.1",
  "description": "Cursor IDE plugin for a16n",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist *.tsbuildinfo",
    "typecheck": "tsc --noEmit",
    "test": "echo 'No tests yet'"
  },
  "dependencies": {
    "@a16njs/models": "workspace:*",
    "glob": "^10.3.0",
    "yaml": "^2.4.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.4.0"
  }
}
EOF

cat > packages/plugin-cursor/tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
EOF

cat > packages/plugin-cursor/src/index.ts << 'EOF'
import type { A16nPlugin, CustomizationType } from '@a16njs/models';

const cursorPlugin: A16nPlugin = {
  id: 'cursor',
  name: 'Cursor IDE',
  supports: ['global-prompt' as CustomizationType],

  async discover(root: string) {
    // TODO: Implement
    return { items: [], warnings: [] };
  },

  async emit(models, root) {
    // TODO: Implement
    return { written: [], warnings: [], unsupported: [] };
  },
};

export default cursorPlugin;
EOF

# @a16njs/plugin-claude
cat > packages/plugin-claude/package.json << 'EOF'
{
  "name": "@a16njs/plugin-claude",
  "version": "0.0.1",
  "description": "Claude Code plugin for a16n",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist *.tsbuildinfo",
    "typecheck": "tsc --noEmit",
    "test": "echo 'No tests yet'"
  },
  "dependencies": {
    "@a16njs/models": "workspace:*",
    "glob": "^10.3.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.4.0"
  }
}
EOF

cat > packages/plugin-claude/tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
EOF

cat > packages/plugin-claude/src/index.ts << 'EOF'
import type { A16nPlugin, CustomizationType } from '@a16njs/models';

const claudePlugin: A16nPlugin = {
  id: 'claude',
  name: 'Claude Code',
  supports: ['global-prompt' as CustomizationType],

  async discover(root: string) {
    // TODO: Implement
    return { items: [], warnings: [] };
  },

  async emit(models, root) {
    // TODO: Implement
    return { written: [], warnings: [], unsupported: [] };
  },
};

export default claudePlugin;
EOF
```

## Step 11: Initialize CLI

```bash
cat > packages/cli/package.json << 'EOF'
{
  "name": "a16n",
  "version": "0.0.1",
  "description": "Agent customization portability for AI coding tools",
  "type": "module",
  "bin": {
    "a16n": "./dist/index.js"
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "clean": "rm -rf dist *.tsbuildinfo",
    "typecheck": "tsc --noEmit",
    "dev": "node --loader ts-node/esm src/index.ts",
    "test": "echo 'No tests yet'"
  },
  "dependencies": {
    "@a16njs/engine": "workspace:*",
    "@a16njs/plugin-cursor": "workspace:*",
    "@a16njs/plugin-claude": "workspace:*",
    "commander": "^12.0.0",
    "chalk": "^5.3.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "ts-node": "^10.9.0",
    "typescript": "^5.4.0"
  }
}
EOF

cat > packages/cli/tsconfig.json << 'EOF'
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
EOF

cat > packages/cli/src/index.ts << 'EOF'
#!/usr/bin/env node
import { Command } from 'commander';
import { A16nEngine } from '@a16njs/engine';
import cursorPlugin from '@a16njs/plugin-cursor';
import claudePlugin from '@a16njs/plugin-claude';

const program = new Command();

program
  .name('a16n')
  .description('Agent customization portability for AI coding tools')
  .version('0.0.1');

program
  .command('convert')
  .description('Convert agent customization between tools')
  .requiredOption('-f, --from <agent>', 'Source agent')
  .requiredOption('-t, --to <agent>', 'Target agent')
  .option('--dry-run', 'Show what would happen without writing')
  .option('--json', 'Output as JSON')
  .option('-q, --quiet', 'Suppress non-error output')
  .argument('[path]', 'Project path', '.')
  .action(async (path, options) => {
    const engine = new A16nEngine([cursorPlugin, claudePlugin]);

    try {
      const result = await engine.convert({
        source: options.from,
        target: options.to,
        root: path,
        dryRun: options.dryRun,
      });

      if (options.json) {
        console.log(JSON.stringify(result, null, 2));
      } else {
        console.log(`Discovered: ${result.discovered.length} items`);
        console.log(`Written: ${result.written.length} files`);
        console.log(`Warnings: ${result.warnings.length}`);
      }
    } catch (error) {
      console.error(`Error: ${(error as Error).message}`);
      process.exit(1);
    }
  });

program
  .command('discover')
  .description('List agent customization without converting')
  .requiredOption('-f, --from <agent>', 'Agent to discover')
  .option('--json', 'Output as JSON')
  .argument('[path]', 'Project path', '.')
  .action(async (path, options) => {
    const engine = new A16nEngine([cursorPlugin, claudePlugin]);

    try {
      const result = await engine.discover(options.from, path);

      if (options.json) {
        console.log(JSON.stringify(result, null, 2));
      } else {
        console.log(`Found ${result.items.length} items`);
        for (const item of result.items) {
          console.log(`  - ${item.type}: ${item.sourcePath}`);
        }
      }
    } catch (error) {
      console.error(`Error: ${(error as Error).message}`);
      process.exit(1);
    }
  });

program
  .command('plugins')
  .description('Show available plugins')
  .action(() => {
    const engine = new A16nEngine([cursorPlugin, claudePlugin]);
    const plugins = engine.listPlugins();

    console.log('Available plugins:\n');
    for (const plugin of plugins) {
      console.log(`  ${plugin.id}`);
      console.log(`    Name: ${plugin.name}`);
      console.log(`    Supports: ${plugin.supports.join(', ')}\n`);
    }
  });

program.parse();
EOF
```

## Step 12: Install Dependencies & Build

```bash
# Install all dependencies
pnpm install

# Build all packages
pnpm build
```

## Step 13: Verify Setup

```bash
# Check that CLI works
node packages/cli/dist/index.js --help

# Or via pnpm
pnpm --filter a16n exec -- node dist/index.js plugins

# Should output:
# Available plugins:
#
#   cursor
#     Name: Cursor IDE
#     Supports: global-prompt
#
#   claude
#     Name: Claude Code
#     Supports: global-prompt
```

## Step 14: Initial Commit

```bash
git add .
git commit -m "Initial monorepo setup"
```

---

## Verification Checklist

After completing all steps, verify:

- [ ] `pnpm install` completes without errors
- [ ] `pnpm build` completes without errors
- [ ] `pnpm typecheck` passes
- [ ] `node packages/cli/dist/index.js --help` shows help
- [ ] `node packages/cli/dist/index.js plugins` lists both plugins
- [ ] All 5 packages have `dist/` directories with compiled JS

## Next Steps

With the skeleton in place, proceed to implement:

1. Cursor plugin discovery (Task 3 in Phase 1 spec)
2. Cursor plugin emission (Task 4)
3. Claude plugin discovery (Task 5)
4. Claude plugin emission (Task 6)
5. Integration tests (Task 9)
