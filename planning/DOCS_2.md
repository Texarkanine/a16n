# Documentation Site Brief

## Approach

Unified Docusaurus site in `apps/docs`. Hand-written guides plus TypeDoc-generated API reference. API markdown is generated at CI build time only—never committed, never in anyone's local clone.

## Structure

```
apps/docs/
  package.json            # private: true
  docusaurus.config.js
  docs/                   # COMMITTED: hand-written prose only
    core/
      index.md
      getting-started.md
    cli/
      index.md
  .generated/             # GITIGNORED: staging area for full site source
    core/
      index.md            # copied from docs/
      getting-started.md  # copied from docs/
      api/                # generated by TypeDoc
        index.md
        functions/
        classes/
    cli/
      index.md
      api/
  build/                  # GITIGNORED: final static site output

packages/
  core/
    src/
    README.md
  cli/
    src/
    README.md
```

## Key Insight: Staging Area

Docusaurus compiles markdown → React → HTML. You cannot inject markdown after build. So we use a staging directory:

1. **Copy** committed prose from `docs/` → `.generated/`
2. **Generate** API markdown into `.generated/*/api/`
3. **Build** Docusaurus from `.generated/`

The `.generated/` directory is gitignored. It only exists during CI builds. Local clones never see it unless a developer runs the full build locally.

## Toolchain

| Tool | Purpose |
|------|---------|
| Docusaurus | Static site framework |
| TypeDoc | Extracts API docs from TSDoc comments |
| typedoc-plugin-markdown | TypeDoc outputs markdown instead of HTML |

## Build Scripts

```json
// apps/docs/package.json
{
  "scripts": {
    "build": "npm run stage && npm run apidoc && docusaurus build --docs-dir .generated",
    "stage": "rm -rf .generated && cp -r docs .generated",
    "apidoc": "npm run apidoc:core && npm run apidoc:cli",
    "apidoc:core": "typedoc --plugin typedoc-plugin-markdown --out .generated/core/api ../../packages/core/src/index.ts",
    "apidoc:cli": "typedoc --plugin typedoc-plugin-markdown --out .generated/cli/api ../../packages/cli/src/index.ts"
  }
}
```

## Gitignore

```gitignore
# apps/docs/.gitignore
.generated/
build/
```

## CI Workflow

```yaml
# .github/workflows/docs.yml
name: Deploy Docs

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run build --workspace=apps/docs
      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apps/docs/build
```

## What Lives Where

| Location | Committed? | Contents |
|----------|------------|----------|
| `docs/` | ✅ Yes | Hand-written guides, prose |
| `.generated/` | ❌ No | Staging: prose + generated API |
| `build/` | ❌ No | Final HTML site |

Local developers editing docs work in `docs/`. They never see `.generated/` unless they run `npm run build` locally. CI creates `.generated/`, builds the site, deploys, done.

## Versioned API Docs

All historical versions are generated at build time and browsable, but only latest is search-indexed.

### CI Version Generation

```bash
# Generate API docs for each historical tag
for tag in $(git tag --list 'core@*'); do
  version="${tag#core@}"
  git checkout "$tag" -- packages/core/src
  typedoc --out ".generated/core/api/${version}" packages/core/src/index.ts
  git checkout main -- packages/core/src
done

# Symlink latest for easy linking
ln -s "$(ls -v .generated/core/api | tail -1)" .generated/core/api/latest
```

### Result Structure

```
.generated/core/api/
  1.0.0/
  1.1.0/
  2.0.0/
  latest -> 2.0.0
```

### Version Picker

Automatic React dropdown component reading from generated `versions.json` manifest.

**Requirements:**
- Latest versions at top of dropdown
- Auto-generated from build script (no manual maintenance)
- Per-package version selection

**Implementation:**

```tsx
// src/components/VersionPicker/index.tsx
import React, { useState, useEffect } from 'react';
import { useLocation, useHistory } from '@docusaurus/router';

interface VersionManifest {
  [pkg: string]: string[]; // e.g., { "models": ["0.2.0", "0.1.0"], ... }
}

export default function VersionPicker({ pkg }: { pkg: string }) {
  const [versions, setVersions] = useState<string[]>([]);
  const location = useLocation();
  const history = useHistory();

  useEffect(() => {
    fetch('/versions.json')
      .then(r => r.json())
      .then((manifest: VersionManifest) => {
        // Sort descending (latest first)
        const sorted = (manifest[pkg] || []).sort((a, b) => 
          b.localeCompare(a, undefined, { numeric: true })
        );
        setVersions(sorted);
      });
  }, [pkg]);

  const currentVersion = location.pathname.match(/\/api\/(\d+\.\d+\.\d+)\//)?.[1] || 'latest';

  const handleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newVersion = e.target.value;
    const newPath = location.pathname.replace(
      /\/api\/(latest|\d+\.\d+\.\d+)\//,
      `/api/${newVersion}/`
    );
    history.push(newPath);
  };

  return (
    <select value={currentVersion} onChange={handleChange}>
      <option value="latest">latest</option>
      {versions.map(v => (
        <option key={v} value={v}>{v}</option>
      ))}
    </select>
  );
}
```

**Build Script (generates versions.json):**

```bash
# scripts/generate-versions-manifest.sh
declare -A versions
for tag in $(git tag -l); do
  pkg="${tag%@*}"      # @a16njs/models@0.2.0 → @a16njs/models
  ver="${tag##*@}"     # @a16njs/models@0.2.0 → 0.2.0
  versions[$pkg]+="\"$ver\","
done

echo "{" > .generated/versions.json
for pkg in "${!versions[@]}"; do
  echo "  \"$pkg\": [${versions[$pkg]%,}]," >> .generated/versions.json
done
echo "}" >> .generated/versions.json
```

## Search

Local search via `@easyops-dev/docusaurus-search-local`. Indexes at build time, works offline, no external service.

### Install

```bash
npm install @easyops-dev/docusaurus-search-local
```

### Config

```js
// docusaurus.config.js
themes: [
  ['@easyops-dev/docusaurus-search-local', {
    hashed: true,
    indexDocs: true,
    indexBlog: false,
    // Only index latest API version—old versions browsable but not searchable
    ignoreFiles: [/\/api\/\d+\.\d+\.\d+\//],
  }]
]
```

### Behavior

| Content | Indexed? | Browsable? |
|---------|----------|------------|
| Hand-written guides | ✅ | ✅ |
| API docs (latest) | ✅ | ✅ |
| API docs (old versions) | ❌ | ✅ |

Users searching find latest by default. Old version URLs still work for direct links, bookmarks, or manual navigation.

## Trade-offs Accepted

- Build time scales with tag count (cacheable)
- Local dev preview requires full build (or skip API docs for faster iteration)
