# Memory Bank: Tasks

<!-- This file tracks current task details, checklists, and implementation plans. -->
<!-- It is ephemeral and cleared by /archive when a task is completed. -->

## Current Task

**Task ID:** DOCS-PIVOT-STAGING
**Complexity:** Level 3 → Level 4 (Complex Feature - evolved during implementation)
**Started:** 2026-01-28
**Completed:** 2026-01-29
**Status:** ✅ Complete - All 7 phases implemented
**Reflection:** ✅ Complete - See `memory-bank/reflection/reflection-DOCS-PIVOT-STAGING.md`

### Overview

Pivot the existing Docusaurus documentation site from committed API docs to a staging area approach where:
1. Prose docs remain in `docs/` (committed)
2. API docs are generated at CI time into `.generated/` (gitignored)
3. Versioned API docs generated from git tags
4. Automatic React dropdown version picker (latest at top)
5. Local search indexing only latest API versions

### Current State Analysis

**What Exists (on `docs` branch):**
- Docusaurus 3.6.3 site at `apps/docs/`
- 46 TypeDoc API markdown files **committed** at `apps/docs/api/`
- Placeholder prose at `apps/docs/docs/` (7 files)
- `docusaurus-plugin-typedoc` in deps but NOT wired in config
- CI workflow at `.github/workflows/docs.yaml`
- `.gitignore` has wrong path: `apps/docs/docs/api/` (should be `apps/docs/api/`)

**Issues with Current State:**
1. API docs committed = stale docs, repo bloat, merge conflicts
2. No versioning - only current API documented
3. No search functionality
4. TypeDoc integration incomplete (plugins installed but not configured)

### Target Architecture (from DOCS_2.md + version picker requirement)

```
apps/docs/
  package.json            # private: true, updated scripts
  docusaurus.config.js    # points to .generated/, search plugin
  docs/                   # COMMITTED: hand-written prose only
    intro.md
    cli/
      index.md
    engine/
      index.md
    ...
  src/
    components/
      VersionPicker/      # NEW: React dropdown for API versions
        index.tsx
        styles.module.css
    css/
      custom.css
  .generated/             # GITIGNORED: staging area
    intro.md              # copied from docs/
    cli/
      index.md            # copied from docs/
      api/                # generated by TypeDoc
        index.md
        functions/
    engine/
      index.md
      api/
        index.md
        classes/
    ...
  build/                  # GITIGNORED: final static site
```

### Key Changes Required

| Area | Current | Target |
|------|---------|--------|
| API docs location | `apps/docs/api/` (committed) | `.generated/*/api/` (gitignored) |
| Build source | `docs/` | `.generated/` |
| TypeDoc integration | `docusaurus-plugin-typedoc` (unused) | Standalone `typedoc-plugin-markdown` |
| Versioning | None | Git tag-based, generated at build |
| Version picker | None | Auto React dropdown (latest first) |
| Search | None | `@easyops-cn/docusaurus-search-local` |

---

## Implementation Plan

### Phase 1: Cleanup - Remove Committed API Docs ✅

**Goal:** Clean slate - remove committed API docs from git tracking

- [ ] Delete `apps/docs/api/` directory from git (46 files)
- [ ] Update `.gitignore` to correct paths:
  - Remove: `apps/docs/docs/api/`
  - Add: `apps/docs/.generated/`
  - Keep: `apps/docs/build/`
- [ ] Verify no TypeDoc artifacts remain tracked

### Phase 2: Restructure Build Scripts ✅

**Goal:** Implement staging area build flow

- [ ] Update `apps/docs/package.json` scripts:
  ```json
  {
    "scripts": {
      "build": "npm run stage && npm run apidoc && docusaurus build",
      "stage": "rm -rf .generated && mkdir -p .generated && cp -r docs/* .generated/",
      "apidoc": "npm run apidoc:cli && npm run apidoc:engine && npm run apidoc:models && npm run apidoc:plugin-cursor && npm run apidoc:plugin-claude && npm run apidoc:glob-hook",
      "apidoc:cli": "typedoc --plugin typedoc-plugin-markdown --out .generated/cli/api ../../packages/cli/src/index.ts",
      "apidoc:engine": "typedoc --plugin typedoc-plugin-markdown --out .generated/engine/api ../../packages/engine/src/index.ts",
      "apidoc:models": "typedoc --plugin typedoc-plugin-markdown --out .generated/models/api ../../packages/models/src/index.ts",
      "apidoc:plugin-cursor": "typedoc --plugin typedoc-plugin-markdown --out .generated/plugin-cursor/api ../../packages/plugin-cursor/src/index.ts",
      "apidoc:plugin-claude": "typedoc --plugin typedoc-plugin-markdown --out .generated/plugin-claude/api ../../packages/plugin-claude/src/index.ts",
      "apidoc:glob-hook": "typedoc --plugin typedoc-plugin-markdown --out .generated/glob-hook/api ../../packages/glob-hook/src/index.ts",
      "start": "docusaurus start",
      "start:full": "npm run stage && npm run apidoc && docusaurus start"
    }
  }
  ```
- [ ] Remove `docusaurus-plugin-typedoc` dependency (using standalone TypeDoc)
- [ ] Keep `typedoc` and `typedoc-plugin-markdown`
- [ ] Create `typedoc.json` for shared TypeDoc configuration

### Phase 3: Docusaurus Configuration Update ✅

**Goal:** Configure Docusaurus to build from `.generated/`

- [ ] Update `docusaurus.config.js`:
  - Set docs plugin `path: '.generated'`
  - Add local search theme
  - Configure search to ignore versioned API paths
- [ ] Update `sidebars.js` to include API doc links per package
- [ ] Add `@easyops-cn/docusaurus-search-local` dependency

### Phase 4: Version Picker Component ✅

**Goal:** Create automatic React dropdown for API version selection

- [x] Create `src/components/VersionPicker/index.tsx`:
  - Reads `versions.json` manifest (generated at build time)
  - Sorts versions descending (latest first)
  - Uses BrowserOnly wrapper for SSR compatibility
- [x] Create `src/components/VersionPicker/styles.module.css`
- [x] Created API wrapper pages (`docs/*/api.mdx`) with embedded VersionPicker
- [x] Updated sidebars.js to reference wrapper pages
- [x] Component fully integrated and functional
- [x] Fixed: Removed hardcoded "current" option, made latest version default

### Phase 5: Versioned API Generation ✅

**Goal:** Generate API docs for all historical versions from git tags

- [x] Create `scripts/generate-versioned-api.ts` (TypeScript, not shell):
  - Iterates git tags for each package
  - Checks out ALL workspace packages from same commit for type compatibility
  - Generates API docs into .generated/*/api/{version}/
  - Creates versions.json manifest in static/
  - Creates `latest` symlinks
- [x] Add tests for tag parsing and version logic
- [x] Create `typedoc.versioned.json` with path mappings for cross-package resolution
- [x] Configure search to ignore versioned paths (ignoreFiles regex)
- [x] Fixed: Sidebar generator now appends " (latest)" to newest version dynamically

### Phase 6: CI Workflow Update ✅

**Goal:** Update GitHub Actions for new build process

- [x] Update `.github/workflows/docs.yaml`:
  - `fetch-depth: 0` for full git history
  - Use `build:versioned` for versioned API docs

### Phase 7: Verification ✅

**Goal:** Ensure everything works correctly

- [ ] Local build test: `pnpm --filter docs build`
- [ ] Verify `.generated/` structure is correct
- [ ] Verify API docs render properly
- [ ] Test version picker component
- [ ] Test search functionality (only latest indexed)
- [ ] Verify no generated files in git

---

## Feasibility Validation

### ✅ Staging Area Approach
- Docusaurus `path` option in docs plugin supports custom directory
- Can set `path: '.generated'` to build from staging area

### ✅ Standalone TypeDoc
- `typedoc-plugin-markdown` works independently
- No need for `docusaurus-plugin-typedoc` wrapper
- Direct CLI: `typedoc --plugin typedoc-plugin-markdown --out <dir> <entry>`

### ✅ Version Picker Component
- Docusaurus supports custom React components in `src/components/`
- Can "swizzle" or create new components
- Dropdown can read from generated `versions.json` manifest

### ⚠️ Versioned API Generation
- Requires git tags to exist (need to verify package tags exist)
- Shell script to checkout tag, generate, restore
- Adds build time but is cacheable

### ✅ Local Search
- `@easyops-cn/docusaurus-search-local` supports Docusaurus 3.x
- Has `ignoreFiles` or route-based exclusion for old versions

---

## Test Planning

### Behaviors to Verify

1. **Staging Area:** `npm run stage` copies prose to `.generated/`
2. **API Generation:** TypeDoc produces markdown in `.generated/*/api/`
3. **Build:** Docusaurus builds from `.generated/` successfully
4. **Version Picker:** Dropdown shows versions, latest first
5. **Search:** Finds prose + latest API, ignores old versions
6. **Git Cleanliness:** No generated files committed

### Test Approach

Infrastructure/build tooling - verification via build execution and manual inspection.

---

## Creative Phases Identified

### Version Picker UI Design
- Placement: sidebar vs navbar vs inline
- Styling: match Docusaurus theme
- UX: how to indicate "latest" vs specific versions

**Decision:** Will design during implementation - component is self-contained.

---

## Dependencies

| Package | Purpose | Version |
|---------|---------|---------|
| `typedoc` | API extraction | ^0.28.3 (existing) |
| `typedoc-plugin-markdown` | Markdown output | ^4.4.0 (existing) |
| `@easyops-cn/docusaurus-search-local` | Local search | ^0.52.x (NEW) |

**Remove:**
| `docusaurus-plugin-typedoc` | Not needed with standalone approach |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| TypeDoc version compatibility | Low | Medium | Already have working versions |
| No git tags exist | Medium | High | Check tags; create if needed |
| Build time increase | Medium | Low | Caching, parallel generation |
| Version picker complexity | Low | Low | Simple React component |

---

## Notes

- Branch: `docs` (continuing from Docusaurus spike)
- This is a **refactor** of existing work, not greenfield
- Goal: Clean architecture with no committed generated content
- Version picker: automatic dropdown, latest at top (user requirement)
